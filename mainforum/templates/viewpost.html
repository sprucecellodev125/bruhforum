{% extends "master.html" %}
{% load static %}
{% block title %} {{ post.posttitle }} {% endblock %}

{% block content %}
<script>
  function removeComment(commentId) {
    if (confirm("Are you sure you want to delete this comment?")) {
        fetch('/api/removecomment/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                'commentId': commentId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                document.getElementById('commentrow-' + commentId).remove();  // remove the banned user from the table
            } else {
                alert('Error occurred while banning user!');
            }
        })
        .catch(error => console.log(error));
    }
  }
</script>
<div class="container p-3">
  {% if is_banned and user.is_authenticated %}
  <div class="alert alert-danger">
    You have been banned from this forum. You can see any post and comment, but you can't create new post or post a comment
  </div>
  <br>
  {% endif %}
  <div class="col-md-12 mb-3">
    <div class="card">
      <div class="card-body">
        <h4 class="card-title">{{ post.posttitle }}</h4>
         <p class="card-text">{{ post.postmessage }}</p>
         <p class="card-subtitle text-muted">Posted by {{ post.postusername }} at {{ post.postdate }}</p>
       </div>
    </div>
  </div>
</div>
<div class="container pt-5">
    <p>Comments:</p>
    {% for comment in comments %}
    {% if comment.postcontent.id == postcontent.id %}
    <div class="col-md-12 mb-3" id="commentrow-{{ comment.id }}">
        <div class="card">
          <div class="card-body">
            <h6 class="card-title">{{ comment.commentusername }}</h6>
            <p class="card-text">{{ comment.commentmessage }}</p>
            <p class="card-subtitle text-muted">{{ comment.commentdate }}</p>
            {% if is_mod %}
             <button class="btn btn-danger btn-sm float-end" onclick="removeComment({{ comment.id }})">Remove</button>
            {% else %}
             <span></span>
            {% endif %}
          </div>
        </div>
      </div>
    {% endif %}
    {% endfor %}
    {% if user.is_authenticated and is_banned %}
    <p>You don't have permission to post comment</p>
    {% elif user.is_authenticated %}
      <form method="post">
        {% csrf_token %}
          <input type="hidden" name="commentusername" value="{{ request.user.username }}">
            <div class="mb-3">
              <label for="commentmessage">Comment:</label>
              <textarea name="commentmessage" class="form-control" id="commentmessage" rows="5"></textarea>
            </div>
          <button type="submit" class="btn btn-primary">Submit</button>
      </form>
    {% else %}
    <p>You need to log-in to post comment</p>
    {% endif %}
</div>
{% endblock %}